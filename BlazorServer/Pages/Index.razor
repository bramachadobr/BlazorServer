@page "/"
@using System
@using System.IO
@using BlazorServer.Data
@using System.Globalization
@using System.Timers
@inject IJSRuntime JSRuntime
@inject IMatDialogService MatDialogService
@inject DialogService RadDialogService




@*<RadzenButton Text="@text"></RadzenButton>
<RadzenButton Text="Hi" Click=@ButtonClicked></RadzenButton>
<MatButton OnClick="@(_=>OpenDialogFromService())">Open</MatButton>
<MatButton OnClick="@(_=>OpenDialog())">Open</MatButton>*@


<p></p>

<ComponetAlertMessege Enumtipo=EnumTipoAlerts.info Message="Bem vindo ao novo app G-Ponto (Gerenciamento do Ponto de Colaboradores) v4.0" />
<MatTabGroup>

    <MatTab Label="1-Carregar Arquivo">
        <p></p>
        <div>
            @*<div Class="row"<RadzenDropDown AllowClear="true" TValue="string" Style="width:300px" Data=@value1ItemsCombo @bind-Value="@RegoligoSelecionado" /></div>*@
            <div Class="row"><MatFileUpload OnChange="@FilesReady" AllowMultiple="false" Label="Selecione um único arquivo aqui no navegador"></MatFileUpload></div>
        </div>
        <p></p>
    </MatTab>

    <MatTab Label="2-Filtrar Colaborador">
        <p></p>
        <div class="content">
            <div class="row">
                <div class="col-sm">
@*                    <MatSelectValue @bind-Value="@idSelectd" Items="@cs.Colaboradores" Outlined="true" ValueSelector="@(i=>i.Id)" Label="Selecione Colaborador">
                                <ItemTemplate>
                                        <span>@context.Nome</span>
                                </ItemTemplate>
                    </MatSelectValue>*@

                    <RadzenDropDownDataGrid TValue="Guid" @bind-Value="@idSelectd" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.StartsWith"
                                        AllowFiltering="true" AllowClear="true" Data="@cs.Colaboradores" TextProperty="Nome" ValueProperty="Id" 
                                        Style="width:100%" />

                </div>
                <div class="col-sm">
                    @*<MatDatePicker @bind-Value="@Data1" Format="dd-MM-yy" Label="Data Inicio" Class="w-100" Outlined="true"></MatDatePicker>*@
                    <RadzenDatePicker @bind-Value=@Data1 DateFormat="dd/MM/yyyy" Change=@(args => OnChange(args, "DatePicker", "dd/MM/yyyy")) />
                </div>
                <div class="col-sm">
                    @*<MatDatePicker @bind-Value="@Data2" Format="dd-MM-yy" Label="Data Final" Class="w-100" Outlined="true" ></MatDatePicker>*@
                    <RadzenDatePicker @bind-Value=@Data2 DateFormat="dd/MM/yyyy" Change=@(args => OnChange(args, "DatePicker", "dd/MM/yyyy")) />
                </div>
                <div class="col-lg btn">
                    <RadzenButton Click="@FiltroPonto">Filtrar</RadzenButton>
                    @*<MatButton Raised="true" Type="submit" OnClick="@FiltroPonto">Filtrar</MatButton>*@
                </div>
            </div>
        </div>
    </MatTab>
    <MatTab Label="3-Processar">
        <p></p>
        <div class="row">
            <div class="col-sm"><MatButton Raised="true" Type="submit" OnClick="@ProcessaPontos" >Processar Horas</MatButton></div>
            <div class="col-sm align-content-center">
                <div class="h6">Registros do colaborador no périodo selecionado</div></div>
        </div>
        <div class="row">

            <div id="PrintDiv">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Colaborador</th>
                            <th scope="col">DiaSemana</th>
                            <th scope="col">Data</th>
                            <th scope="col">AM_ENT</th>
                            <th scope="col">AM_SAI</th>
                            <th scope="col">PM_ENT</th>
                            <th scope="col">PM_SAI</th>
                            <th scope="col">NOI_ENT</th>
                            <th scope="col">NOI_SAI</th>
                            <th scope="col">TotalHorasDia</th>
                        </tr>
                    </thead>
                    <tbody>
                            @foreach (var item in @rps.registroPontos)
                            {
                                
                                <tr class=@Convert.ToString(item.TotalHorasDia < TimeSpan.Zero ? "table-danger":"")>
                                    <td>@item.Colaborador.Nome</td>
                                    <td>@item.DiaSemanaPtBr</td>
                                    <td>@item.Data.ToShortDateString()</td>
                                    <td>@item.AM_ENT.ToString("HH:mm")</td>
                                    <td>@item.AM_SAI.ToString("HH:mm")</td>
                                    <td>@item.PM_ENT.ToString("HH:mm")</td>
                                    <td>@item.PM_SAI.ToString("HH:mm")</td>
                                    <td>@item.NOI_ENT.ToString("HH:mm")</td>
                                    <td>@item.NOI_SAI.ToString("HH:mm")</td>
                                    <td>@item.TotalHorasDia</td>
                                </tr>
                            }
                    </tbody>
                </table>
            </div>



                <MatTable Items="@rps.registroPontos" class="mat-elevation-z5" Striped="true" RequestApiOnlyOnce="true" AllowSelection="true" PageSize=25 SelectionChanged="SelectionChangedEvent" >
                    <MatTableHeader>
                        <th>Colaborador</th>
                        <th>DiaSemana</th>
                        <th>Data</th>
                        <th>AM_ENT</th>
                        <th>AM_SAI</th>
                        <th>PM_ENT</th>
                        <th>PM_SAI</th>
                        <th>NOI_ENT</th>
                        <th>NOI_SAI</th>
                        <th>TotalHorasDia</th>
                    </MatTableHeader>
                    <MatTableRow>
                        <td>@context.Colaborador.Nome</td>
                        <td>@context.DiaSemanaPtBr</td>
                        <td>@context.Data.ToShortDateString()</td>
                        <td>@string.Format("{0:HH:mm}", @context.AM_ENT)</td>
                        <td>@string.Format("{0:HH:mm}", @context.AM_SAI)</td>
                        <td>@string.Format("{0:HH:mm}", @context.PM_ENT)</td>
                        <td>@string.Format("{0:HH:mm}", @context.PM_SAI)</td>
                        <td>@string.Format("{0:HH:mm}", @context.NOI_ENT)</td>
                        <td>@string.Format("{0:HH:mm}", @context.NOI_SAI)</td>
                        @if (@context.TotalHorasDia > TimeSpan.Zero)
                        {
                            <td>@context.TotalHorasDia</td>
@*                          <td><MatButton Disabled="true" Icon="edit" OnClick="@OpenDialog">Editar</MatButton></td>
                            <td><RadzenButton Text="Ediast com RadZen" Click="@OpenDialog">Ediatr</RadzenButton></td>*@
                        }
                        else
                        {
                            <td style="background:red">@context.TotalHorasDia</td>
@*                          <td><MatButton Icon="edit" OnClick="@OpenDialog">Editar</MatButton></td>
                            <td><RadzenButton Text="Ediast com RadZen" Click="@OpenDialog">Ediatr</RadzenButton></td>*@
                        }
                    </MatTableRow>
                </MatTable>
        </div>
    </MatTab>
    <MatTab Label="4-Gerar aquivo de ponto">
        Second Content
    </MatTab>
    <MatTab Label="5-Impressão">
        Second Content
    </MatTab>
</MatTabGroup>


     <MatDialog @bind-IsOpen="@dialogIsOpen">
            <MatDialogTitle>Editar Ponto</MatDialogTitle>
            <MatDialogContent>
                <EditForm Model="@regPonto" OnValidSubmit="Success">
@*                    <MatTextField Label="ValorHora" @bind-Value="regPonto.ValorHora"/>
                    <MatTextField Label="ValorHora" @bind-Value="regPonto.ValorTotal"/>*@
                    
                    <p><b>Entrada manhã</b></p>
                    <RadzenDatePicker TValue="DateTime" @bind-Value="regPonto.AM_ENT" ShowTime="true" TimeOnly="true" DateFormat="HH:mm"/> @*Change=@(args => OnChange(args, "Time-only DatePicker", "HH:mm"))*@
                    <p><b>Saída manhã</b></p>
                    <RadzenDatePicker TValue="DateTime" @bind-Value="regPonto.AM_SAI" ShowTime="true" TimeOnly="true" DateFormat="HH:mm"/>
                    <p><b>Entrada tarde</b></p>
                    <RadzenDatePicker TValue="DateTime" @bind-Value="regPonto.PM_ENT" ShowTime="true" TimeOnly="true" DateFormat="HH:mm"/>
                    <p><b>Saída tarde</b></p>
                    <RadzenDatePicker TValue="DateTime" @bind-Value="regPonto.PM_SAI" ShowTime="true" TimeOnly="true" DateFormat="HH:mm"/>
                    <p><b>Entrada noite</b></p>
                    <RadzenDatePicker TValue="DateTime" @bind-Value="regPonto.NOI_ENT" ShowTime="true" TimeOnly="true" DateFormat="HH:mm"/>
                    <p><b>Saída noite</b></p>
                    <RadzenDatePicker TValue="DateTime" @bind-Value="regPonto.NOI_SAI" ShowTime="true" TimeOnly="true" DateFormat="HH:mm"/>
                    <a>@regPonto.TotalHorasDia</a>

                </EditForm>
            </MatDialogContent>
            <MatDialogActions>
                <MatButton OnClick="@(e => { dialogIsOpen = false; })">Cancelar</MatButton>
                <MatButton OnClick="@OkClick">Salvar</MatButton>
            </MatDialogActions>
        </MatDialog>

      

<div class="row">
            <p>
            @if (ListRegPonto.Count >0)
            {
                <MatTable Items="@filtro" class="mat-elevation-z5" Striped="true" RequestApiOnlyOnce="true" AllowSelection="true" PageSize=25 >
                    <MatTableHeader>
                        <th>Cod</th>
                        <th class=col-sm>Nome</th>
                        <th class=col-sm>CPF</th>
                        <th class=col-sm>Data</th>
                        <th class=col-sm>Hora</th>
                    </MatTableHeader>
                    <MatTableRow>
                        <td>@context.CodColaborador</td>
                        <td>@context.Colaborador.Nome</td>
                        <td>@string.Format("{0:0000.000.000-00}", @context.Cpf)</td>
                        <td>@context.Data.ToShortDateString()</td>
                        <td>@string.Format("{0:HH:mm}", @context.Data)</td>
                    </MatTableRow>
                </MatTable>
            }
        </p>
</div>


@code
{

    //Evento ao clicar na grid 
    void SelectionChangedEvent(object reg)
    {
        if(reg !=null)
        {
            if (((RegistroPonto)reg).TotalHorasDia.TotalHours < 0)
            {
                regPonto = (RegistroPonto)reg;
                this.StateHasChanged();
                dialogIsOpen = true;
            }
        }
    }


    string text = "Hi";
    

   void ButtonClicked()
   {
   }

    void OnChange(DateTime? value, string name, string format)
    {
        JSRuntime.InvokeAsync<object>("console.log", $"{name} value changed to {value?.ToString(format)}");
    }

    //async Task Success() => await JSRuntime.InvokeAsync<object>("alert", "Successful login!");

    async Task Success()
    {
        await JSRuntime.InvokeAsync<object>("alert", "Successful login!");
    }

    public Data.RegistroPonto regPonto = new RegistroPonto();
    public bool dialogIsOpen = false;

    CultureInfo Cultura = new CultureInfo("pt-BR");

    public string Nome { get; set; }
    public DateTime? Data { get; set; }

    public Guid idSelectd { get; set; }

    public DateTime Data1 { get; set; }

    public DateTime Data2 { get; set; }

    public DateTime DataMais1 { get => Data2.AddDays(1); }


    string RegoligoSelecionado = "Nacional";
    string[] value1ItemsCombo = new[]
    {
        "Nacional",
        "Chines",
    };

    List<Arquivo> listArquivo = new List<Arquivo>();

    List<string> listAlert = new List<string>();

    List<Data.RegistroRelogio> ListRegPonto = new List<RegistroRelogio>();

    List<Data.RegistroRelogio> filtro = new List<RegistroRelogio>();

    Service.ColaboradorService cs = new Service.ColaboradorService();

    Service.RegistroPontoService rps = new Service.RegistroPontoService();

    void OkClick()
    {
        dialogIsOpen = false;
    }

    void OpenDialog()
    {
        dialogIsOpen = true;
    }   

    async Task OpenDialogFromService()
    {
        await MatDialogService.OpenAsync(typeof(DemoDialogItem), null);
    }

    public void FiltroPonto()
    {
        filtro = ListRegPonto;

        if (idSelectd!=Guid.Empty)
        {
            int codigo = cs.Colaboradores.FirstOrDefault(x => x.Id.Equals(idSelectd)).CodPonto;
            filtro = ListRegPonto.Where<RegistroRelogio>(i => i.CodColaborador.Equals(codigo)).ToList();
        }
        if (Data1 != DateTime.MinValue && Data2 != DateTime.MinValue)
        {
            if(idSelectd != Guid.Empty)
            {
                int codigo = cs.Colaboradores.FirstOrDefault(x => x.Id.Equals(idSelectd)).CodPonto;
                filtro = ListRegPonto.Where<RegistroRelogio>(i => i.CodColaborador.Equals(codigo) && i.Data >= Data1 && i.Data <= DataMais1).ToList();
            }
            else
                filtro = ListRegPonto.Where<RegistroRelogio>(i => i.Data >= Data1 && i.Data <= DataMais1).ToList();
        }
    }


    protected override void OnInitialized()
    {
        base.OnInitialized();
        cs.LoadColaboradores();
        rps.colaboradores = cs.Colaboradores;
    }

    
    async Task FilesReady2(string files)
    {
        await JSRuntime.InvokeVoidAsync("console.log", "teste", files);
    }


    async Task FilesReady(IMatFileUploadEntry[] files)
    {
        string extensao = string.Empty;
        var file = files.FirstOrDefault();
        extensao = file.Name.Substring(file.Name.IndexOf("."), file.Name.Length - file.Name.IndexOf("."));

        if (!extensao.Equals(".txt"))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Arquivo selecionado não é um arquivo válido!");
            return;
        }
        else
        {
            listAlert.Add($"Nome: {file.Name} - Tamanho: {file.Size}");
        }

        var ms = new MemoryStream();

        await file.WriteToStreamAsync(ms);

        StreamReader sr = new StreamReader(ms);

        List<string> linhas = new List<string>();

        ms.Position = 0;

        string linha = "";
        
        while (!(linha is null))
        {
            linha = sr.ReadLine();
            if (linha != null)
            {
                linhas.Add(linha);
            }
        }

        List<string> lista = new List<string>();

        ms.Position = 0;

        string sline = "";

        while (sline != null)
        {
            sline = sr.ReadLine();
            if (sline != "")
            {
                lista.Add(sline);
            }
        }

        //U{5}P{12}D{2}M{2}A{4}H{2}N{2}

        foreach (var item in lista)
        {
            if (item!=null)
            {
                string cod = item.Substring(0, 5);
                string cpf = item.Substring(5, 12);
                string dia = item.Substring(17, 2);
                string mes = item.Substring(19, 2);
                string ano = item.Substring(21, 4);
                string hh = item.Substring(25, 2);
                string mm = item.Substring(27, 2);

                string sData = $"{dia}/{mes}/{ano} {hh}:{mm}";

                RegistroRelogio reg = new RegistroRelogio();

                reg.CodColaborador = Convert.ToInt32(cod);
                reg.Colaborador = await cs.GetColaboradorByIdPonto(Convert.ToInt32(cod));
                reg.Cpf = cpf;
                reg.Data = Convert.ToDateTime(sData, Cultura);
                ListRegPonto.Add(reg);
            }
        }
        FiltroPonto();
    }

    public override bool Equals(object obj)
    {
        return obj is Index index &&
               RegoligoSelecionado == index.RegoligoSelecionado;
    }

    public override int GetHashCode()
    {
        return HashCode.Combine(RegoligoSelecionado);
    }

    async Task ProcessaPontos()
    {


        if (idSelectd != Guid.Empty)
        {
            Data.Colaborador colab = await cs.GetColaboradorById(idSelectd);

            var filtro = ListRegPonto.Where(x => x.Colaborador.Id.Equals(colab.Id) && x.Data >= Data1 && x.Data <= DataMais1).GroupBy(i => i.Data.ToShortDateString()).ToArray();
            var filtro3 = ListRegPonto.Where(x => x.Colaborador.Id.Equals(colab.Id) && x.Data >= Data1 && x.Data <= DataMais1).GroupBy(i => i.Data).Select(x => new {Value = x.Count(), Data=(DateTime)x.Key }).ToArray();

            foreach (var item in filtro)
            {
                await JSRuntime.InvokeVoidAsync("console.log", "teste", item);
                RegistroPonto ponto = new RegistroPonto();
                ponto.Data = Convert.ToDateTime(item.Key);
                ponto.Colaborador = colab;
                ponto.ColaboradorId = colab.Id;
                foreach (var i in item)
                {
                    ponto.AddHora(i.Data);
                    await JSRuntime.InvokeVoidAsync("console.log", "teste", i);
                }
                if(rps.ValidaPontoExiste(ponto) == false)
                    rps.AddRecord(ponto);
            }
        }
        else
        {
            var filtro = ListRegPonto.GroupBy(i=>i.Data.ToShortDateString()).ToList();

            foreach (var item in filtro)
            {
                var colaboradores = item.GroupBy(i => i.Colaborador).ToList();

                foreach (var colab in colaboradores)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", "todos", item);
                    RegistroPonto ponto = new RegistroPonto();
                    ponto.Data = Convert.ToDateTime(item.Key);
                    ponto.Colaborador = colab.FirstOrDefault().Colaborador;
                    ponto.ColaboradorId = colab.FirstOrDefault().Id;
                    foreach (var i in colab)
                    {
                        ponto.AddHora(i.Data);
                        await JSRuntime.InvokeVoidAsync("console.log", "teste", i);
                    }
                    rps.AddRecord(ponto);
                }
            }
        }
    }

}